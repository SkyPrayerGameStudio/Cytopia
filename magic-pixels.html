<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cytopia: Magic Pixels</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="Doc-styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cytopia_icon_iso.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cytopia
   &#160;<span id="projectnumber">0.3</span>
   </div>
   <div id="projectbrief">A city building simulation game</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('magic-pixels.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Magic Pixels </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#magic-pixels-criteria">Magic Pixel Criteria</a></li>
<li class="level1"><a href="#magic-pixels-using">How to use</a></li>
<li class="level1"><a href="#magic-pixels-recoloring">Recoloring algorithm</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="magic-pixels-criteria"></a>
Magic Pixel Criteria</h1>
<p>A magic pixel is a pixel which has the same RED and BLUE values. This includes black, white, grays, purples, and greens. From this criteria, there are \(255 \times 255 \times 255 = 16581375\) possible magic pixels that you can use (Pick a green, pick an alpha, and pick a red-blue). Magic pixels are less than 0.4% of all the possible pixel colors you can use.</p>
<h1><a class="anchor" id="magic-pixels-using"></a>
How to use</h1>
<p>When a sprite has magic pixels and is being tagged as recolorable, Cytopia will be allowed to recolor those pixels at runtime. This can be done randomly, or specifically depending on for what your asset is being used. Randomly refers to picking a random color and recoloring all magic pixels with it, while specifically refers to using a specific color.</p>
<h1><a class="anchor" id="magic-pixels-recoloring"></a>
Recoloring algorithm</h1>
<p>Recoloring is done in the following manner: Given a sprite of RGBA pixels, and a target RGBA color, we find all pixels that are "magic" according to the <a class="el" href="magic-pixels.html#magic-pixels-criteria">Magic Pixel Criteria</a>. For each of these magic pixels, we apply the following filter </p><p class="formulaDsp">
\begin{align*} H_o &amp;= H_t\\ S_o &amp;= \mathrm{overlay}(S_i, S_t)\\ L_o &amp;= \mathrm{overlay}(L_i, L_t)\\ \end{align*}
</p>
<p> Where \(H_o, S_o, L_o\) are the resulting hue, saturation, and lightness, \(H_i, S_i, L_i\) are the magic pixel's hue, saturation, and lightness, \(H_t, S_t, L_t\) are the target's hue, saturation, and lightness, and we define </p><p class="formulaDsp">
\begin{align*} \mathrm{overlay}(X, Y) &amp;= \begin{cases} \frac{2}{100}XY &amp; \mathrm{if } X &lt; 50\\ 100 - \frac{2}{100}(100-X)(100-Y) &amp; \mathrm{otherwise} \end{cases} \end{align*}
</p>
<p> With RGB, we derive the following. Given \(X_{min}=\min\{R_o,G_o,B_o\}\) and \(X_{max}=\max\{R_o,G_o,B_o\}\), we have that </p><p class="formulaDsp">
\begin{align*} L_o &amp;= \mathrm{mid}\{R_o,G_o,B_o\} = \mathrm{overlay}\left(\mathrm{mid}\{R_i, G_i, B_i\}, \mathrm{mid}\{R_t,G_t,B_t\}\right)\\ X_{max} + X_{min} &amp;= 2L_o &amp; (1)\\ S_o &amp;= \frac{X_{max}-X_{min}}{\min\{L_o, 1-L_o\}} = \mathrm{overlay}\left( \frac{\max\{R_i,G_i,B_i\} - \min\{R_i,G_i,B_i\}}{\min\{\mathrm{mid}\{R_i,G_i,B_i\}, 1-\mathrm{mid}\{R_i,G_i,B_i\}\}}, \frac{\max\{R_t,G_t,B_t\} - \min\{R_t,G_t,B_t\}}{\min\{\mathrm{mid}\{R_t,G_t,B_t\}, 1-\mathrm{mid}\{R_t,G_t,B_t\}\}}, \right)\\ X_{max}-X_{min} &amp;=S_o\min\{L_o, 1-L_o\} &amp; (2)\\ \end{align*}
</p>
<p> From Eqn (1), you can see that \(L_o=0\implies X_{max}=-X_{min}=0\), hence if there is no lightness, we always return black. From Eqn (2), you can see that \(S_o=0\implies X_{max}=X_{min}=L_o\), hence if there is no saturation, we always return a grayscale color. Note that if any denominator in the \(S_o\) equation is 0, then \(S_o=0\) to prevent dividing by 0. Finally for hue, there are many ways to convert it back to RGB. </p>
 <style type="text/css">
 .pixel-block {
   width: 100px;
   height: 100px;
   display: inline-block;
   box-sizing: border-box;
   border: 1px solid hsl(0, 0%, 80%);
   border-radius: 5px;
 }
 .pixel-block-text {
   line-height: 20px;
   vertical-align: middle;
 }
 .pixel-section {
   width: 100px;
   height: 130px;
   display: inline-block;
   vertical-align: middle;
 }
 .pixel-section > input {
   width: 100px;
   box-sizing: border-box;
   margin-top: 5px;
   font-family: 'Inter', sans-serif;
 }
 .pixel-section > input[error="true"] {
   border-color: red;
 }
 #magic-pixels-example {
   box-sizing: border-box;
   padding: 10px;
 }
 #magic-pixels-example > span {
   font-size: 20px;
   font-weight: 300;
 }
 #magic-color-picker {
   margin-top: 5px;
 }
 </style>
 <script type="text/javascript">
 function overlay(X, Y) {
   if(X < 255 / 2) return 2 * X * Y / 255;
   return 255 - 2 * (255 - X) * (255 - Y) / 255;
 }
 function recolor_magic(magic, target) {
   // Not a magic pixel 
   if(magic[0] != magic[2]) return magic;
   var min_i = Math.min(...magic);
   var max_i = Math.max(...magic);
   var mid_i = (max_i + min_i) / 2;
   var min_t = Math.min(...target);
   var max_t = Math.max(...target);
   var mid_t = (max_t + min_t) / 2;
   var lo = overlay(mid_i, mid_t);
   if(lo == 0) return [0, 0, 0];
   console.log("Midi: ", mid_i, " Midt: ", mid_t);
   if(mid_i == 0 || mid_i == 255 || mid_t == 0 || mid_t == 255) return [Math.floor(lo), Math.floor(lo), Math.floor(lo)];
   console.log("1: ", Math.floor(255 * (max_i - min_i) / Math.min(mid_i, 255-mid_i) / 2));
   console.log("2: ", Math.floor(255 * (max_t - min_t) / Math.min(mid_t, 255-mid_t) / 2));
   var so = overlay(Math.floor(255 * (max_i - min_i) / Math.min(mid_i, 255-mid_i) / 2), Math.floor(255 * (max_t - min_t) / Math.min(mid_t, 255-mid_t) / 2));
   console.log("sat: ", so);
   if(so == 0) return [Math.floor(lo), Math.floor(lo), Math.floor(lo)];
   var it = target.indexOf(max_t);
   var ho = (60 * (2 * it + (target[(it+1)%3] - target[(it+2)%3])/(max_t-min_t)) + 360) % 360;
   console.log("hue: ", ho);
   return [
     Math.floor(lo - so * Math.min(lo, 255-lo) * Math.max(-1, Math.min((0+ho/30)%12 - 3, 9 - (0+ho/30)%12, 1)) / 255),
     Math.floor(lo - so * Math.min(lo, 255-lo) * Math.max(-1, Math.min((8+ho/30)%12 - 3, 9 - (8+ho/30)%12, 1)) / 255),
     Math.floor(lo - so * Math.min(lo, 255-lo) * Math.max(-1, Math.min((4+ho/30)%12 - 3, 9 - (4+ho/30)%12, 1)) / 255)
   ];
 }
 function get_color(element, color) {
   var match = element.value.match(/^#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/);
   if(!match) {
     element.setAttribute("error", "true");
     throw "Invalid color string";
   }
   element.setAttribute("error", "false");
   color.style['background-color'] = element.value;
   return [ 
     parseInt(match[1], 16),
     parseInt(match[2], 16),
     parseInt(match[3], 16)
   ]
 }
 function magic_pixel_update() {
   try {
     color_magic = get_color(document.getElementById("magic-pixel-value"), 
         document.getElementById("magic-pixel"));
     color_target = get_color(document.getElementById("target-pixel-value"),
         document.getElementById("target-pixel"));
     console.log("Magic: ", color_magic);
     console.log("Target: ", color_target);
     result_color = recolor_magic(color_magic, color_target);
     console.log("Result: ", result_color);
     result_color = "#" 
     + ("00" + result_color[0].toString(16)).substr(-2) 
     + ("00" + result_color[1].toString(16)).substr(-2)
     + ("00" + result_color[2].toString(16)).substr(-2);
     document.getElementById("result-pixel-value").value = result_color;
     document.getElementById("result-pixel").style['background-color'] = result_color;
   } catch(e) {
     console.error(e);
     return;
   }
 }
 </script>
 <div id="magic-pixels-example">
   <span>Chose some colors to see how magic coloring works</span>
   <center>
   <div id="magic-color-picker">
     <div class="pixel-section">
       <div id="magic-pixel" class="pixel-block" style="background-color: #000000;"></div>
       <br />
       <input id="magic-pixel-value" value="#000000", onchange="magic_pixel_update(this)" />
     </div>
     <span class="pixel-block-text">+</span>
     <div class="pixel-section">
       <div id="target-pixel" class="pixel-block" style="background-color: #FF0000;"></div>
       <br />
       <input id="target-pixel-value" value="#FF0000" onchange="magic_pixel_update(this)" />
     </div>
     <span class="pixel-block-text">=</span>
     <div class="pixel-section">
       <div id="result-pixel" class="pixel-block" style="background-color: #000000;"></div>
       <br />
       <input id="result-pixel-value" value="#000000" readonly/>
     </div>
   </div>
   </center>
 </div>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Sep 5 2020 18:39:23 for Cytopia by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
